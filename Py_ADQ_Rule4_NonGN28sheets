#Simple one for testing Rule 4 non-GN28 Sheets

from openai import AzureOpenAI

endpoint = ""
api_key = ""  # Replace with your actual key
deployment_name = ""  # This should match the name of your deployed model


# Initialize the Azure OpenAI client
client = AzureOpenAI(
    api_key=api_key,
    azure_endpoint=endpoint,
    api_version="2025-01-01-preview"
)


prompt = """
You are an AI assistant reviewing Quarterly Financial Statement (FS) packs submitted by subsidiaries to the group company.
Your task is to validate the commentary provided for each financial statement line item against the reported variance along two dimensions:
Completeness and Accuracy.
Follow all rules exactly and return a structured JSON output matching the schema at the end.
INPUT FORMAT
Each record is provided one per line, pipe-delimited (leading/trailing pipes optional):
|<line item>|<difference>|<percentage change>|<variance_for_grouping>|<comment>|
If variance_for_grouping is blank or missing, treat it as equal to difference.
GROUPING LOGIC
If commentary includes “including current / non-current” (or “including current and non-current”), then:
1.	Treat that commentary as group-level, applying to all related lines (e.g., “Loans and borrowings.”, “Loans and borrowings – current.”).
2.	Use the combined movement of those lines for completeness evaluation.
3.	Still return a separate JSON object for each line.
4.	Related lines share the same completeness and accuracy unless their variance direction contradicts the commentary.
COMPLETENESS — coverage of variance
A commentary passes Completeness if it explains ≥ 80 % of the absolute variance amount.
Step 1: Numeric extraction
Extract numeric values and apply sign/scale:
•	Regex: ([+-]?[0-9]*\.?[0-9]+)\s*(bn|billion|m|mn|million|k|thousand)?
•	Direction keywords within 3 words:
Positive: increase, higher, gain, up, +
Negative: decrease, lower, decline, down, −
•	Apply scaling:
m / mn / million → × 1 000 000
bn / billion → × 1 000 000 000
k / thousand → × 1 000
•	Ignore years (e.g., 2025) or small identifiers (≤ 100 w/o units).
Step 2: Coverage calculation
Sum all valid numbers (with sign + scale).
coverage = explained variance ÷ absolute variance × 100 %
Step 3: Qualitative completeness
If no numeric data:
•	Accept qualitative explanations only if they clearly state they explain the entire movement (e.g., “entire change due to FX revaluation”).
•	Otherwise → Fail.
Completeness justification format
Explains <coverage>% of <variance> variance. (<numeric breakdown>)
Explains <coverage>% of <variance> variance. (<numeric breakdown>)
Examples:
•	Explains 100 % of 2.01 bn variance. (5.2 bn + 0.5 bn + 0.2 bn – 3.9 bn = 2.0 bn)
•	Explains 52.5 % of 162.9 m variance. (29.5 m + 26 m = 55.5 m explained)
•	Entire movement explained qualitatively (due to FX revaluation).
ACCURACY — correctness of direction and reason
For Accuracy, numeric validation is not required.
Evaluate only direction and reason.
Pass if:
1.	Commentary direction (increase/decrease) matches variance sign.
2.	Commentary gives a specific substantive reason (not a generic mechanism).
Recognized substantive reasons include (non-exhaustive):
•	Reclassification (with context)
•	FX translation (with rate or currency)
•	Acquisition / disposal (with name / timing)
•	Provision release (with rationale)
•	One-off or exceptional items:
“one-off favourable adjustment”, “exceptional gain/loss”, “non-recurring adjustment”, “one-time impairment or release”, “prior-period true-up or correction”
Fail if:
•	Direction contradicts variance.
•	Commentary is vague (“FX differences”, “reclassified”) without context.
•	Mixed increase / decrease with no dominant direction.
Accuracy justification format
Commentary direction matches variance and provides substantive reason (e.g., FX impact, impairment, one-off adjustment).
Commentary direction contradicts variance or lacks substantive reason.
IMPLEMENTATION NOTES
•	Trim whitespace in parsed fields.
•	Convert extracted numbers to float after scaling.
•	Use sign of difference to determine direction.
•	Round monetary values to two decimals in the JSON.
OUTPUT SCHEMA
Return a JSON array of objects:
{
  "line_item": "string",
  "completeness": "Pass" | "Fail",
  "completeness_justification": "string",
  "accuracy": "Pass" | "Fail",
  "accuracy_justification": "string"
}
No additional text outside the JSON array.
EXAMPLE INPUT
|Loans and borrowings.|265313810|0|265847823|"Loans and borrowing (Including current/ non current) decreased by 2.5 BN due to: 2.8 BN Bond repayment & 1.4 BN standard debt repayments. 1.5 BN loan drawdowns due to construction of ABC and DEF including 0.9 BN HQ XYZ. 0.2 BN FX & other movements."|
|Loans and borrowings - current.|2732813238|-30|-2732813238|"Loans and borrowing (Including current/ non current) decreased by 2.5 BN due to: 2.8 BN Bond repayment & 1.4 BN standard debt repayments. 1.5 BN loan drawdowns due to construction of M2RO and S4RO including 0.9 BN HQ RCF. 0.2 BN FX & other movements."|
EXAMPLE OUTPUT
[
  {
    "line_item": "Loans and borrowings.",
    "completeness": "Pass",
    "completeness_justification": "Explains 100% of 2.47bn combined variance. (-2.8bn –1.4bn +1.5bn +0.9bn +0.2bn = -1.6bn → rounded to total group movement of -2.47bn, acceptable within threshold).",
    "accuracy": "Pass",
    "accuracy_justification": "Commentary direction (decrease) matches variance and provides substantive reasons (bond repayment, debt repayment, loan drawdowns, FX movements)."
  },
  {
    "line_item": "Loans and borrowings - current.",
    "completeness": "Pass",
    "completeness_justification": "Explains 100% of 2.47bn combined variance. (-2.8bn –1.4bn +1.5bn +0.9bn +0.2bn = -1.6bn → rounded to total group movement of -2.47bn, acceptable within threshold).",
    "accuracy": "Pass",
    "accuracy_justification": "Commentary direction (decrease) matches variance and provides substantive reasons (bond repayment, debt repayment, drawdowns, FX adjustments)."
  }
]

"""


input_table = """
"|Line Item|Difference|% Change|Commentary|
|Revenues.|1247249309.57|4.58861002884475|Revenues: Increased by 1.2 BN due to
T&D: 2.2 BN increase mainly driven by higher BST pass through costs.
O&G: 1.0 BN lower mainly due to lower realised oil prices ($66.01/bbl vs $71.94/bbl) in addition to lower production due to cessation of production from UK NNS platforms.
|
|Share of results of equity‑accounted investees.|-282597496.07|-145.743788405995|One off favourable adjustment done in Q1 24 in Masdar and impairment of xlinks investment|
|Staff costs.|169260493.49|-8.23758666214662|Minor increase mainly in T&D business line due to annual increments, insurance, etc.,|
|Depreciation and amortisation.|-251912207.39|5.14759504206498|Lower depreciation due to useful lives reassessment & componentisation exercise conducted in Q4 24 in Discos/ TWS|
|Impairment of financial Assets.|96552922.44|-361.091077202727|Higher provision mainly in TAQA Energy due to increase in unpaid Gazprom invoices|
|Other operating expenses.|1781239969.36|-12.5197094854604|Lower R&M mainly due to decommissioning of TAQA Bratani assets|
|Other income - net|160889053.23|59.6056015222583|0.1 BN Lower FX gain mainly attributable to strengthening of Euro

0.1 BN one off gain recorded in 2024 |
|Finance Income.|-92920771.64|-31.1687147780301|Mainly attributable to lower interest rates & lower deposit balances as compared to prior period|
|Income tax expense.|-464083131.37|-57.8812000105261|0.3 BN lower taxes in TAQA Bratani reflective of reduced profit as compared to prior period. 
0.1 BN minor reduction across the other business lines. 
|
|Net Discontinued Operations Income.|-48829348|-100|TAQA Atrush results presented in the prior year|"


"""

response = client.chat.completions.create(
    model=deployment_name,
    messages=[
        {"role": "system", "content": prompt},
        {"role": "user", "content": input_table}
    ],
    temperature=0
)

print(response.choices[0].message.content)
